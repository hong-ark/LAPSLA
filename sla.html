<!doctype html>
btn.addEventListener('click', async () => {
const url = webAppUrlInput.value.trim();
if (!url) { setStatus('Isi Web App URL Apps Script terlebih dahulu.', 'err'); return; }
if (!lastParsed) { setStatus('Belum ada file CSV yang dipilih / diparsing.', 'err'); return; }


// cari nama kolom status sla dan Bagian asal (case-insensitive)
const headerLower = lastHeader.map(h => h.toLowerCase());
const idxStatus = headerLower.findIndex(h => h === 'status sla' || h === 'status_sla' || h === 'status');
const idxBagian = headerLower.findIndex(h => h === 'bagian asal' || h === 'bagian_asal' || h === 'bagian asal' || h === 'bagian');


if (idxStatus === -1) { setStatus('Kolom "status sla" tidak ditemukan di header CSV.', 'err'); return; }
if (idxBagian === -1) { setStatus('Kolom "Bagian asal" tidak ditemukan di header CSV.', 'err'); return; }


const keyStatus = lastHeader[idxStatus];
const keyBagian = lastHeader[idxBagian];


// filter baris: status sla == "lewat sla" && Bagian asal == "store"
const filteredRows = lastParsed.filter(r => {
const s = (r[keyStatus]||'').toString().trim().toLowerCase();
const b = (r[keyBagian]||'').toString().trim().toLowerCase();
return s === 'lewat sla' && b === 'store';
});


if (filteredRows.length === 0) { setStatus('Tidak ada baris yang memenuhi kriteria (lewat sla & Bagian asal=store).', 'err'); return; }


// bangun array of arrays mengikuti urutan header agar dapat dimasukkan ke sheet
const rows = filteredRows.map(r => lastHeader.map(h => r[h] || ''));


const payload = { rows: rows };


setStatus('Mengirim ' + rows.length + ' baris terfilter ke Apps Script...', '');
try {
const resp = await fetch(url, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});
const text = await resp.text();
if (!resp.ok) throw new Error(text || resp.statusText);
setStatus('Berhasil: ' + text, 'ok');
} catch (err) {
setStatus('Gagal mengirim: ' + err.message, 'err');
}
});


function setStatus(msg, type) {
statusArea.innerHTML = '<p class="' + (type||'') + '">' + msg + '</p>';
}
</script>
